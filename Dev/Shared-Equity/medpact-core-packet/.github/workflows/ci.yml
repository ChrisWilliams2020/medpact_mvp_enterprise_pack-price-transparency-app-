name: CI

on:
  push:
    branches: [ main, ci/** ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: medpactdb
          POSTGRES_USER: medpact
          POSTGRES_PASSWORD: medpactpass
        ports: ['5433:5432']
        options: >-
          --health-cmd pg_isready -U medpact -d medpactdb
          --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Wait for Postgres
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          until pg_isready -h localhost -p 5433 -U medpact -d medpactdb; do sleep 1; done
        env:
          PGPASSWORD: medpactpass

      - name: Build solution
        run: dotnet build apps/api/MedPact.Core.sln -c Release --no-restore

      - name: Run EF migrations
        run: |
          dotnet tool install --global dotnet-ef --version 8.* || true
          export PATH="$HOME/.dotnet/tools:$PATH"
          dotnet ef database update --project apps/api/MedPact.Infrastructure --startup-project apps/api/MedPact.Api --connection "Host=localhost;Port=5433;Database=medpactdb;Username=medpact;Password=medpactpass"

      - name: Run provider tests
        run: dotnet test apps/api/MedPact.ProviderTests/MedPact.ProviderTests.csproj -c Debug --no-build --logger "trx;LogFileName=provider-tests.trx"

      - name: Build frontend
        working-directory: apps/web
        run: |
          npm ci
          npm run build

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: provider-tests
          path: apps/api/MedPact.ProviderTests/TestResults
name: CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-$(hashFiles('**/*.csproj'))

      - name: Restore
        run: dotnet restore apps/api/MedPact.Core.sln

      - name: Build
        run: dotnet build apps/api/MedPact.Core.sln -c Release --no-restore

      - name: Run tests
        run: |
          if [ -d "apps/api" ]; then
            dotnet test apps/api/MedPact.Core.sln --no-restore --verbosity minimal || true
          else
            echo "No tests found"
          fi

      - name: Build Docker image (optional)
        if: runner.os == 'Linux'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: apps/api/MedPact.Api/Dockerfile
          tags: medpact/api:ci-${{ github.sha }}

  e2e-smoke:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Start services
        run: |
          API_PORT=5100 docker compose up -d
      - name: Build frontend (optional)
        if: always()
        run: |
          if [ -d "apps/web" ]; then
            docker build -f apps/web/Dockerfile -t medpact/web:ci . || true
          else
            echo "No frontend to build"
          fi
      - name: Run provider tests (Pact verifier)
        env:
          BASE_URL: http://localhost:5100
        run: |
          ls -la apps/api/pacts || true
          dotnet test apps/api/MedPact.ProviderTests/MedPact.ProviderTests.csproj --no-build -v minimal || true
      - name: Run contract tests
        env:
          BASE_URL: http://localhost:5100
        run: |
          bash scripts/contract_test.sh
      - name: Install Node and newman
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install newman
        run: |
          cd scripts && npm ci
          npm ls newman || true
      - name: Run E2E smoke
        env:
          BASE_URL: http://localhost:5100
          ADMIN_EMAIL: "${{ secrets.E2E_ADMIN_EMAIL }}"
          DOCKER_CLEANUP: "true"
        run: |
          bash scripts/e2e_smoke.sh
      - name: Teardown
        if: always()
        run: |
          docker compose down
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-debug
          path: debug/**

  publish:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
      - name: Build and push API image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: apps/api/MedPact.Api/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/medpact-api:${{ github.ref_name }}
      - name: Build and push Web image
        uses: docker/build-push-action@v4
        with:
          context: apps/web
          file: apps/web/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/medpact-web:${{ github.ref_name }}

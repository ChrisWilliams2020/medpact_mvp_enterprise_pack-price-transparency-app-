name: Smoke tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - '**'

jobs:
  # Full smoke test (existing behavior; kept for thorough runs)
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-node-${{ hashFiles('apps/web/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-node-

      - name: Create .env for docker-compose
        run: |
          cat > .env <<'EOF'
          POSTGRES_USER=medpact
          POSTGRES_PASSWORD=medpactpass
          POSTGRES_DB=medpactdb
          POSTGRES_PORT=5432
          CONNECTION_STRING=Host=postgres;Port=5432;Database=medpactdb;Username=medpact;Password=medpactpass
          API_PORT=5100
          PROVIDER_STATES_ENABLED=true
          EOF

      - name: Setup buildx
        uses: docker/setup-buildx-action@v2

      - name: Build API image with Buildx (cache to GHA)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: apps/api/MedPact.Api/Dockerfile
          push: false
          tags: medpact/api:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Start docker-compose (use built images)
        run: |
          docker compose up -d

      - name: Run migrator (apply migrations)
        run: |
          docker compose run --rm migrator

      - name: Wait for API health
        run: |
          i=0
          until (curl --silent --fail http://localhost:5100/health >/dev/null 2>&1) || (curl --silent --fail http://localhost:5100/api/health >/dev/null 2>&1) || [ $i -ge 60 ]; do
            echo -n "."
            sleep 1
            i=$((i+1))
          done
          if ! (curl --silent --fail http://localhost:5100/health >/dev/null 2>&1) && ! (curl --silent --fail http://localhost:5100/api/health >/dev/null 2>&1); then
            echo "API did not become healthy in time"
            docker logs --tail 200 medpact_api || true
            exit 1
          fi

      - name: Run provider tests with coverage
        env:
          DOTNET_ROOT: ${{ runner.tool_cache }}/dotnet
        run: |
          dotnet test apps/api/MedPact.ProviderTests/MedPact.ProviderTests.csproj -c Debug --logger "trx;LogFileName=provider-tests.trx" --collect:"XPlat Code Coverage"

      - name: Run integration tests with coverage
        env:
          DOTNET_ROOT: ${{ runner.tool_cache }}/dotnet
        run: |
          dotnet test apps/api/MedPact.IntegrationTests/MedPact.IntegrationTests.csproj -c Debug --logger "trx;LogFileName=integration-tests.trx" --collect:"XPlat Code Coverage"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: provider-tests-trx
          path: apps/api/MedPact.ProviderTests/TestResults/**/*.trx

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-cobertura
          path: |
            apps/api/MedPact.ProviderTests/TestResults/**/coverage.cobertura.xml
            apps/api/MedPact.IntegrationTests/TestResults/**/coverage.cobertura.xml

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: |
            apps/api/MedPact.ProviderTests/TestResults/**/coverage.cobertura.xml
            apps/api/MedPact.IntegrationTests/TestResults/**/coverage.cobertura.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Find coverage percentage
        id: find_cov
        if: github.event_name == 'pull_request'
        run: |
          cov_file=$(find apps/api/MedPact.ProviderTests/TestResults -name 'coverage.cobertura.xml' | head -n1 || true)
          if [ -z "$cov_file" ]; then
            echo "coverage=not_found" >> $GITHUB_OUTPUT
          else
            line_rate=$(grep -o 'line-rate="[^"]*"' "$cov_file" | head -n1 | sed -E 's/line-rate="([^"]*)"/\1/')
            pct=$(awk -v r="$line_rate" 'BEGIN{ printf("%.1f", r*100) }')
            echo "coverage=$pct" >> $GITHUB_OUTPUT
            echo "coverage_file=$cov_file" >> $GITHUB_OUTPUT
          fi

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && steps.find_cov.outputs.coverage != 'not_found'
        uses: actions/github-script@v7
        with:
          script: |
            const cov = process.env.COVERAGE || 'unknown';
            const covFile = process.env.COVERAGE_FILE || '';
            const pr = context.payload.pull_request.number;
            const body = `Automated coverage report: **${cov}%**\n\nCoverage file: ${covFile}`;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr, body });
        env:
          COVERAGE: ${{ steps.find_cov.outputs.coverage }}
          COVERAGE_FILE: ${{ steps.find_cov.outputs.coverage_file }}

      - name: Collect api logs
        if: failure()
        run: |
          mkdir -p artifacts || true
          docker logs --tail 1000 medpact_api > artifacts/api.log || true

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: api-logs
          path: artifacts/api.log

      - name: Tear down docker-compose
        if: always()
        run: |
          docker compose down -v

  # Faster smoke job for PRs with caching and shorter timeouts
  smoke-fast:
    runs-on: ubuntu-latest
    needs: []
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Create .env for docker-compose
        run: |
          cat > .env <<'EOF'
          POSTGRES_USER=medpact
          POSTGRES_PASSWORD=medpactpass
          POSTGRES_DB=medpactdb
          POSTGRES_PORT=5432
          CONNECTION_STRING=Host=postgres;Port=5432;Database=medpactdb;Username=medpact;Password=medpactpass
          API_PORT=5100
          PROVIDER_STATES_ENABLED=true
          EOF

      - name: Setup buildx
        uses: docker/setup-buildx-action@v2

      - name: Detect 'run-integration' PR label
        id: detect_integration
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return core.setOutput('run', 'false');
            const labels = pr.labels.map(l => l.name);
            core.setOutput('run', labels.includes('run-integration') ? 'true' : 'false');

      - name: Build API image with Buildx (cache to GHA)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: apps/api/MedPact.Api/Dockerfile
          push: false
          tags: medpact/api:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Start minimal services
        run: |
          # start only postgres and api to speed up
          docker compose up -d postgres api

      - name: Run migrator (apply migrations)
        run: |
          docker compose run --rm migrator

      - name: Wait for API health (fast)
        run: |
          i=0
          until (curl --silent --fail http://localhost:5100/health >/dev/null 2>&1) || (curl --silent --fail http://localhost:5100/api/health >/dev/null 2>&1) || [ $i -ge 30 ]; do
            echo -n "."
            sleep 1
            i=$((i+1))
          done
          if ! (curl --silent --fail http://localhost:5100/health >/dev/null 2>&1) && ! (curl --silent --fail http://localhost:5100/api/health >/dev/null 2>&1); then
            echo "API did not become healthy in time"
            docker logs --tail 200 medpact_api || true
            exit 1
          fi

      - name: Run provider tests (fast) with coverage
        env:
          DOTNET_ROOT: ${{ runner.tool_cache }}/dotnet
        run: |
          dotnet test apps/api/MedPact.ProviderTests/MedPact.ProviderTests.csproj -c Debug --logger "trx;LogFileName=provider-tests.trx" --collect:"XPlat Code Coverage"

      - name: Run integration tests (gated)
        if: steps.detect_integration.outputs.run == 'true'
        env:
          DOTNET_ROOT: ${{ runner.tool_cache }}/dotnet
        run: |
          dotnet test apps/api/MedPact.IntegrationTests/MedPact.IntegrationTests.csproj -c Debug --logger "trx;LogFileName=integration-tests.trx" --collect:"XPlat Code Coverage"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: provider-tests-trx
          path: apps/api/MedPact.ProviderTests/TestResults/**/*.trx

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-cobertura
          path: apps/api/MedPact.ProviderTests/TestResults/**/coverage.cobertura.xml

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: apps/api/MedPact.ProviderTests/TestResults/**/coverage.cobertura.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Tear down docker-compose
        if: always()
        run: |
          docker compose down -v

name: Schema validation

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Postgres
        run: |
          docker run -d --name medpact_test_pg -e POSTGRES_DB=medpactdb -e POSTGRES_USER=medpact -e POSTGRES_PASSWORD=medpactpass -p 5433:5432 postgres:16

      - name: Wait for Postgres
        run: |
          i=0
          until pg_isready -h localhost -p 5433 -U medpact || [ $i -ge 30 ]; do
            echo -n "."; sleep 1; i=$((i+1));
          done

      - name: Run migrator against test DB
        run: |
          docker run --rm -v ${{ github.workspace }}:/src -w /src -e ConnectionStrings__Default="Host=host.docker.internal;Port=5433;Database=medpactdb;Username=medpact;Password=medpactpass" mcr.microsoft.com/dotnet/sdk:8.0 /bin/bash -lc \
            "dotnet tool install --global dotnet-ef || true && export PATH=\"$$PATH:$$HOME/.dotnet/tools\" && dotnet ef database update -p apps/api/MedPact.Infrastructure -s apps/api/MedPact.Api"

      - name: Basic schema sanity check
        run: |
          docker exec medpact_test_pg psql -U medpact -d medpactdb -c "\dt" | grep -i tenants || (docker logs medpact_test_pg && exit 1)

      - name: Tear down Postgres
        if: always()
        run: |
          docker rm -f medpact_test_pg || true
